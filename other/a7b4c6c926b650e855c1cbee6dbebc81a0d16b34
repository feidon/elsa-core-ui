import './assets/main.css'

import { createApp } from 'vue'
import App from './App.vue'

import { defineCustomElements as elsaCustomElements } from '../node_modules/@elsa-workflows/elsa-workflows-studio/loader/index.js'

elsaCustomElements()

createApp(App).mount('#app')

function AuthorizationMiddlewarePlugin(elsaStudio: any) {
  const { eventBus } = elsaStudio

  eventBus.on('http-client-created', (e) => {
    // Register Axios middleware.
    e.service.register({
      onRequest(request: { headers: { [x: string]: string } }) {
        request.headers['x-Tenant'] = '3e20e444-4d9e-4dae-b36d-11eac36d9eb0'
        request.headers['Authorization'] =
          'Bearer ' +
          'eyJhbGciOiJSUzI1NiIsImtpZCI6IjI3MDM0RjZDMjU0ODYzRkVCRjdGOTgwNjI3NDBBMjE5OEU1MDExOUQiLCJ0eXAiOiJhdCtqd3QiLCJ4NXQiOiJKd05QYkNWSVlfNl9mNWdHSjBDaUdZNVFFWjAifQ.eyJuYmYiOjE2OTUxMDE1NTcsImV4cCI6MTY5NTEwNTE1NywiaXNzIjoiaHR0cHM6Ly9pZGVudGl0eS1kZXYuc3luY29ib3guY29tIiwiYXVkIjpbImNvbXBhbnlhZG1pbi5hbGwiLCJwcm9kdWN0Y29uZmlndXJhdG9yLmFsbCIsInJlcG9ydGluZy5wcmV2aWV3IiwicG9ydGFsLmFsbCIsIndlYmltc3luYy5hbGwiXSwiY2xpZW50X2lkIjoicG9ydGFsLXNwYSIsInN1YiI6ImZiOTI4YzM4LWJlZjYtNGE4OC1hNzkzLTc0OTM5OGE2M2Q0NiIsImF1dGhfdGltZSI6MTY5NDc0ODc5OSwiaWRwIjoibG9jYWwiLCJBc3BOZXQuSWRlbnRpdHkuU2VjdXJpdHlTdGFtcCI6IlFVUDNVSUVJWkIzNVNHNUhXWFlRTlpCWVdYNEZQWEtTIiwicm9sZSI6IlN5c3RlbUFkbWluIiwicHJlZmVycmVkX3VzZXJuYW1lIjoic3RhbmZlaUB3ZWJpbS5jb20udHciLCJuYW1lIjoic3RhbmZlaUB3ZWJpbS5jb20udHciLCJlbWFpbCI6InN0YW5mZWlAd2ViaW0uY29tLnR3IiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiZmI5MjhjMzgtYmVmNi00YTg4LWE3OTMtNzQ5Mzk4YTYzZDQ2IiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6InN0YW5mZWlAd2ViaW0uY29tLnR3Iiwic3luY29ib3hfY29tcGFueV9pZCI6IjAzMmVhNjEwLTk0MjUtNDRmYy1iMmQzLTM1MmZhNWZjNjk4MiIsInN5bmNvYm94X2NvbXBhbnlfbmFtZSI6Iuihm-atpuizh-ioiiIsInN5bmNvYm94X3VzZXJfbmFtZSI6Iuiyu-iBv-aahCIsInN5bmNvYm94X3VzZXJfaWQiOiJmYjkyOGMzOC1iZWY2LTRhODgtYTc5My03NDkzOThhNjNkNDYiLCJzeW5jb2JveF91c2VyX2VtYWlsIjoic3RhbmZlaUB3ZWJpbS5jb20udHciLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJzdGFuZmVpQHdlYmltLmNvbS50dyIsInNjb3BlIjpbInByb2ZpbGUiLCJvcGVuaWQiLCJjb21wYW55YWRtaW4uYWxsIiwicHJvZHVjdGNvbmZpZ3VyYXRvci5hbGwiLCJyZXBvcnRpbmcucHJldmlldyIsInBvcnRhbC5hbGwiLCJ3ZWJpbXN5bmMuYWxsIiwib2ZmbGluZV9hY2Nlc3MiXSwiYW1yIjpbInB3ZCJdfQ.N8kRyOKe02Xzr6bxS_xO2CBQ45d2nem2Nz4l7Y61i0pb2QCtEcXN3qObtrpbMwUJX3xkctm0Ru3gmPBvc8J8K_r4kwBqRRgiyt542zyQZEuDfOtyVLAOPaZVaM6wapmac3B-jKAeRkudwijfrjgIz_0ku8_ixWIFg3Ie5Vbl8Sn7EdJiaSUKoPxsdLfvKL5lfUWrRAi2LbUnvMwSCF8B3dmhuh90cN-4rE8wsq9RaiJDkXR7PLKFWwofg4mimsoByreSyp24MI3-9l4Rg7JPSqmZm8UWyQHjy7Tq7q_wO0ZHmHRUME0rcOj8SLnVVeszFC6FLOD3mXbPCbn0_ET-DA'

        return request
      },
      onResponse(response: any) {
        return response
      }
    })
  })
}

const elsaStudioRoot = document.querySelector('elsa-studio-root')

elsaStudioRoot?.addEventListener('initializing', (e) => {
  const elsaStudio = e.detail
  elsaStudio.pluginManager.registerPlugin(AuthorizationMiddlewarePlugin)
})
